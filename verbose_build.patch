From 6672cd87bfc51aa301da72a6303d9023fe75a566 Mon Sep 17 00:00:00 2001
From: Jan Palus <jpalus@fastmail.com>
Date: Mon, 1 Jan 2024 19:14:09 +0100
Subject: [PATCH] add option to make verbose builds

if V=1 is passed to make echo invoked command verbosely
---
 Makefile        | 11 +++++++----
 janus/Makefile  |  6 +++---
 python/Makefile |  2 +-
 src/Makefile    |  8 ++++----
 4 files changed, 15 insertions(+), 12 deletions(-)

diff --git a/Makefile b/Makefile
index 9f3ea84c..8dab4c77 100644
--- a/Makefile
+++ b/Makefile
@@ -22,6 +22,9 @@ define optbool
 $(filter $(shell echo $(1) | tr A-Z a-z), yes on 1)
 endef
 
+ifeq ($(V),)
+	ECHO = @
+endif
 
 # =====
 all:
@@ -36,18 +39,18 @@ endif
 
 apps:
 	$(MAKE) -C src
-	@ ln -sf src/ustreamer.bin ustreamer
-	@ ln -sf src/ustreamer-dump.bin ustreamer-dump
+	$(ECHO) ln -sf src/ustreamer.bin ustreamer
+	$(ECHO) ln -sf src/ustreamer-dump.bin ustreamer-dump
 
 
 python:
 	$(MAKE) -C python
-	@ ln -sf python/build/lib.*/*.so .
+	$(ECHO) ln -sf python/build/lib.*/*.so .
 
 
 janus:
 	$(MAKE) -C janus
-	@ ln -sf janus/*.so .
+	$(ECHO) ln -sf janus/*.so .
 
 
 install: all
diff --git a/janus/Makefile b/janus/Makefile
index afbad3ee..90111830 100644
--- a/janus/Makefile
+++ b/janus/Makefile
@@ -31,13 +31,13 @@ endif
 # =====
 $(_PLUGIN): $(_SRCS:%.c=$(_BUILD)/%.o)
 	$(info == SO $@)
-	@ $(CC) $^ -o $@ $(_LDFLAGS)
+	$(ECHO) $(CC) $^ -o $@ $(_LDFLAGS)
 
 
 $(_BUILD)/%.o: %.c
 	$(info -- CC $<)
-	@ mkdir -p $(dir $@) || true
-	@ $(CC) $< -o $@ $(_CFLAGS)
+	$(ECHO) mkdir -p $(dir $@) || true
+	$(ECHO) $(CC) $< -o $@ $(_CFLAGS)
 
 
 
diff --git a/python/Makefile b/python/Makefile
index b9e723c0..a8b60d54 100644
--- a/python/Makefile
+++ b/python/Makefile
@@ -9,7 +9,7 @@ PY ?= python3
 # =====
 all:
 	$(info == PY_BUILD ustreamer-*.so)
-	@ $(PY) setup.py build
+	$(ECHO) $(PY) setup.py build
 
 
 install:
diff --git a/src/Makefile b/src/Makefile
index ac5897a7..a56ae9d4 100644
--- a/src/Makefile
+++ b/src/Makefile
@@ -86,18 +86,18 @@ install-strip: install
 
 $(_USTR): $(_USTR_SRCS:%.c=$(_BUILD)/%.o)
 	$(info == LD $@)
-	@ $(CC) $^ -o $@ $(_LDFLAGS) $(_USTR_LIBS)
+	$(ECHO) $(CC) $^ -o $@ $(_LDFLAGS) $(_USTR_LIBS)
 
 
 $(_DUMP): $(_DUMP_SRCS:%.c=$(_BUILD)/%.o)
 	$(info == LD $@)
-	@ $(CC) $^ -o $@ $(_LDFLAGS) $(_DUMP_LIBS)
+	$(ECHO) $(CC) $^ -o $@ $(_LDFLAGS) $(_DUMP_LIBS)
 
 
 $(_BUILD)/%.o: %.c
 	$(info -- CC $<)
-	@ mkdir -p $(dir $@) || true
-	@ $(CC) $< -o $@ $(_CFLAGS)
+	$(ECHO) mkdir -p $(dir $@) || true
+	$(ECHO) $(CC) $< -o $@ $(_CFLAGS)
 
 
 clean:
